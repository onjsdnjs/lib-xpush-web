<!DOCTYPE html>
<html lang="en">
<head>
	<title>Dashboard</title>
	<style type="text/css">
		circle {
				fill: none;
				stroke-width: 1.5px;
		}
	</style>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

	<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js"></script>
	<script type="text/javascript" src="assets/gauge.js"></script>
	<script src="http://xpush.github.io/lib/dist/xpush.js"></script>
</head>
<body>
	<div class="container">
		<div class="row-fluid">
			<div class="span12">
				<!--PAGE CONTENT BEGINS-->

				<div class="alert alert-block alert-success">
					<button type="button" class="close" data-dismiss="alert">
						<i class="icon-remove"></i>
					</button>
					<i class="icon-ok green"></i>
					Welcome to
					<strong class="green">
						XPUSH Dashboard
					</strong>
				</div>

				<div class="row">
					<div class="col-sm-6">
						<div class="panel panel-default">
							<div class="panel-heading">
								<h4 class="lighter">
									<i class="icon-signal"></i>CPU Stats
								</h4>
							</div>

							<div class="panel-body">
								<div style="display:flex; width: 450px; margin: 0px auto;">
									<div class="infobox infobox-green" style="height:239px; width:150px; text-align:center;">
										<span id="service_tooltip_server01" class="btn btn-small btn-success tooltip-success" data-rel="tooltip" data-placement="top" title="" data-original-title="Active" style="margin:20px 0px 20px 0px;">Active</span>
										<span id="server-01GaugeContainer"></span>
									</div>
									<div class="infobox infobox-green" style="height:239px; width:150px; text-align:center;">
										<span id="service_tooltip_server02" class="btn btn-small" data-rel="tooltip" data-placement="top" title=""  ="standby" style="margin:20px 0px 20px 0px;">Standby</span>
										<span id="server-02GaugeContainer"></span>
									</div>
									<div class="infobox infobox-green" style="height:239px; width:150px; text-align:center;">
										<span id="service_tooltip_server03" class="btn btn-small" data-rel="tooltip" data-placement="top" title="" data-original-title="standby" style="margin:20px 0px 20px 0px;">Standby</span>																																
										<span id="server-03GaugeContainer"></span>
									</div>									
								</div>							       
							</div>
						</div>
					</div>
					<div class="col-sm-6">
						<div class="panel panel-default">
							<div class="panel-heading">
								<h4 class="lighter">
									<i class="icon-signal"></i>TPS View
								</h4>
							</div>
							<div class="panel-body">
								<div id="transaction" style="text-align:center;">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

	<script type="text/javascript">
		var hostNames = ["server-01","server-02","server-03"];
		var sorts = {};
		sorts["server-01"] = 0;
		sorts["server-02"] = 1;
		sorts["server-03"] = 2;
		var serviceNames = ["server01", "server02", "server03"];
		
	  var CircularQueueItem = function (value, next, back) {
		  this.next = next;
		  this.value = value;
		  this.back = back;
		  return this;
	  };

	  var CircularQueue = function (queueLength) {
	    this._current = new CircularQueueItem(undefined, undefined, undefined);
	    var item = this._current;
	    for (var i = 0; i < queueLength - 1; i++) {
	        item.next = new CircularQueueItem(undefined, undefined, item);
	        item = item.next;
	    }
	    item.next = this._current;
	    this._current.back = item;

	    this.push = function (value) {
				this._current.value = value;
				this._current = this._current.next;
	    };
	    this.pop = function () {
        this._current = this._current.back;
        return this._current.value;
	    };
	    return this;
	  }
	
		var gauges = [];
		
		function createGauge(name, label, min, max){
			var config = {
				size: 160,
				label: label,
				min: undefined != min ? min : 0,
				max: undefined != max ? max : 100,
				minorTicks: 5
			}
			
			var range = config.max - config.min;
			config.yellowZones = [{ from: config.min + range*0.7, to: config.min + range*0.9 }];
			config.redZones = [{ from: config.min + range*0.9, to: config.max }];
			
			gauges[name] = new Gauge(name + "GaugeContainer", config);
			gauges[name].render();
		}
		
		function createGauges(){
			for( var inx = 0; inx < hostNames.length; inx++ ){
				createGauge(hostNames[inx], hostNames[inx]);	
			}				
		}
		
		function updateGauges( json ){
			for (var inx = 0, until = json.length; inx < until ; inx ++){
				gauges[json[inx].hostname].redraw(json[inx].value);
			}
		}		
		
		function initialize(){
			createGauges();
			var xpush = new XPush('http://stalk-front-s01.cloudapp.net:8000', 'sample');
			xpush.createSimpleChannel('channel02', function(){

		  	// `message` event로 들어오는 data를 받아 화면에 출력합니다.
				xpush.on( 'message', function(channel, name, data){
					if( data.type == 'tps' ) {
						viewParticle( data.json );
					} else if ( data.type == 'cpu' ) {
						updateGauges( data.json );
					}
				});
			});
		}	
		initialize();					
	</script>

	<script type="text/javascript">
		var w = 500,
	    h = 250,
	    z = d3.scale.category10();
		var cw = 170;

		var svg = d3.select("#transaction").append("svg:svg")
	  .attr("width", w)
	  .attr("height", h);
		
		var data = [0,1,2];
		var sel = svg.selectAll("rect").data(data).enter();
		sel.append("rect")
		.attr("id", function(d) {return "rect_"+serviceNames[d];})
		.attr("fill", "white" )
		.attr("stroke", "#999" )
		.attr("width", 100)
		.attr("height", 40)
		.attr("x", function(d) {return ( d * cw ) + 30;} )
		.attr("y", 210);
		
		sel.append("svg:text")
		.attr("fill", "black")
		.attr("x", function(d) {return ( d * cw ) + 80;})
    .attr("y", 235)
    .attr("text-anchor", "middle")
		.style("font-size", "12px")
		.text(function(d) {return hostNames[d]});
		
		sel.append("image")
		.attr("id", function(d) {return "image"+d;})
		.attr( "xlink:href", "assets/0.png" )
		.attr("x", function(d) {return ( d * cw ) + 35;} )
		.attr("y", 80 )
		.attr("width", 100)
  	.attr("height", 100)
  	.attr("opacity", "1" );
		
		var queues = [];
		for( var key in data ){
			var queue = new CircularQueue(6); // a circular queue with 3 items
			queue.push("5");
			queue.push("4");
			queue.push("3");
			queue.push("2");
			queue.push("1");
			queue.push("0");				
			queues.push( queue );
		}

		function particle( cx, cy, radius, sort ) {			
		  svg.append("svg:circle")
      .attr("cx", cx)
      .attr("cy", cy)
      .attr("r", 1e-6)
      .style("stroke", z(sort * 9))
      .style("stroke-opacity", 1)
			.transition()
      .duration(5000)
      .ease(Math.sqrt)
      .attr("r", radius)
      .style("stroke-opacity", 1e-6)
      .remove();
		}
							
		function runHorse( val, sort ){
			var img = svg.select("#image"+ sort );
			if( val == 0 ){
				if( img.attr("opacity") == 1 ){
					img.attr( "opacity", "1" )
					.transition()
					.duration(500)
					.attr( "opacity", "0.5" );
				}
				return;
			} else {
				if( img.attr("opacity") == 0.5 ){						
					img.attr( "opacity", "0.5" )
					.transition()
					.duration(500)
					.attr( "opacity", "1" );
				}					
			}				
			
			var speed = Math.round( 10000 / val );
			
			svg.append("svg:text")
			.attr("fill", "#000")
			.attr("x", (sort * cw ) + 105 )
      .attr("y", 190)
      .attr("text-anchor", "end")
			.style("font-size", "16px")
			.text( val )
			.transition()
	    .duration(5200)
	    .style("stroke-opacity", 1e-6)
	    .remove(); 
			
			var now = Date.now();
			var t = setInterval(function(){
				img.attr( "xlink:href", "assets/"+queues[sort].pop() +".png" );
				if ( Date.now() - now > 5250 ){
					clearInterval(t);
				}
			}, speed );
		}
			
		function viewParticle( json ){

			var totalTps = 0;
			for (var inx = 0, len = json.length; inx < len ; inx ++){
				var val = json[inx].val;
				totalTps = plus( totalTps, Number( val ) );
				var sort = sorts[json[inx].hostname];
				runHorse( val, sort );
				
				if( val != 0 ){						
					// Position X
					var cx = ( sort * cw ) + 85;
					var until = Math.floor( val / 100 ) * 5 ;
					
					var jnx = 1;
					if( until < 1 ){
						until = 1;
					}					
					
					while( jnx <= until ){							
						particle( cx, 130, val * ( jnx * ( 1/until) ), sort );
						jnx++;
					}
				}
			}					
			setTotal( Number(totalTps).toFixed(2) );
		}
		
		function changeRectColor( serviceNm, isActive ){
			var rect = svg.select("#rect_"+serviceNm);
			if( isActive ){
				rect.attr( "fill", "#87B87F" );
			} else {
				rect.attr( "fill", "#ABBAC3" );
			}
		}
		
		function setTotal( totalTps ){
			svg.append("svg:text")
			.attr("fill", "#000")
			.attr("x", 290 )
      .attr("y", 65)
      .attr("text-anchor", "end")
			.style("font-size", "30px")
			.text( totalTps )
			.transition()
	    .duration(5200)
	    .style("stroke-opacity", 1e-6)
			.remove();
		}
		
		function plus() {
			var argsLength = arguments.length;
			 
			if(argsLength == 0) return 0;
			 
			var result = 0.0;  //결과값 
			var argString = "";  //문자열로 변환된 파라미터
			var pointIndex = 0;  //소수점의 위치
			var decimalSize = 0; //소수의 자리수
			var maxDecimalSize = 0; //파라미터 중 가장 소수점이 큰 수의 소수 자리수
			var maxPower = 1.0;  //파라미터 중 가장 소수점이 큰 수의 소수 자리수 * 10
			 
			for(var inx = 0; inx < argsLength; inx++) {
			 
				argString = arguments[inx] + "";
				pointIndex = argString.indexOf(".");
				decimalSize = (pointIndex < 0) ? 0 : argString.length - pointIndex - 1;
			  
				if(maxDecimalSize < decimalSize) {
			   	result = result * Math.pow(10.0, decimalSize - maxDecimalSize);
			   	maxDecimalSize = decimalSize;
					maxPower = Math.pow(10.0, maxDecimalSize);
			  }
			  
				result += eval((parseFloat(arguments[inx]) * maxPower).toFixed(0));
			}
			return (result / maxPower);
		}

		var send = function(){
			setInterval(function(){
				xpush.send( 'channel02', 'message',
					{ type : 'tps', json : [
							{'val':100, 'hostname':'server-01'},
							{'val':200, 'hostname':'server-02'},
							{'val':300, 'hostname':'server-03'}]}
				);
			}, 5000 );

			setInterval(function(){
				xpush.send( 'channel02', 'message',
					{ type : 'cpu', json : [
							{'value':70, 'hostname':'server-01'},
							{'value':80, 'hostname':'server-02'},
							{'value':90, 'hostname':'server-03'}]}
				);
			}, 5000 );	
		};		
	</script>